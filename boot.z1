(struct boot/context
  ctxt-books
  ctxt-comp
  ctxt-gfx)

(struct boot/gfx
  gfx-pixels)

(struct boot/gfx-event
  (gfxev-type u16)
  (gfxev-x u16)
  (gfxev-y u16)
  (gfxev-state u16)
  (gfxev-input u32))

(struct boot/gfx-command
  (gfxcmd-op u32)
  (gfxcmd-arg1 u32)
  (gfxcmd-arg2 u32)
  (gfxcmd-arg3 u32))

(fun (boot/gfx-cmd op arg1 arg2 arg3)
  (mem cmd boot/gfx-command)
  (set (boot/gfxcmd-op cmd) op)
  (set (boot/gfxcmd-arg1 cmd) arg1)
  (set (boot/gfxcmd-arg2 cmd) arg2)
  (set (boot/gfxcmd-arg3 cmd) arg3)
  (sys/call 1 4 cmd boot/gfx-command))

(fun (boot/gfx-show)
  (boot/gfx-cmd 2))

(fun (boot/gfx-wait)
  (mem event boot/gfx-event)
  (label loop)
  (sys/call 0 5 event boot/gfx-event)
  (if (== (boot/gfxev-type event) 1)
      (begin)
   (goto loop)))

(fun (boot/gfx-rect x y w h c)
  (var gfx (boot/ctxt-gfx context))
  (var pixels (+ (boot/gfx-pixels gfx) (* (+ x (* y 1024)) 4)))
  (var skip (* (- 1024 w) 4))
  (var i)
  (var j)
  (set j 0)
  (while (< j h)
   (set i 0)
   (while (< i w)
    (set (u32 pixels) c)
    (set pixels (+ pixels 4))
    (set i (+ i 1)))
   (set pixels (+ pixels skip))
   (set j (+ j 1))))

(fun (boot/gfx-init)
  (var bytes (* 1024 768 4))
  (if (< (sys/call 77 3 bytes) 0)
      (sys/call 60 12))
  (set (boot/gfx-pixels (boot/ctxt-gfx context))
       (sys/call 9 0 bytes 3 1 3 0))
  (boot/gfx-cmd 1 1024 768))

(fun (boot/gfx-color r g b)
  (+ (* (+ (* r 256) g) 256) b))

(fun (boot/print-int n)
  (mem buf 40)
  (var end (+ buf 40))
  (var ptr end)
  (set ptr (- ptr 1))
  (set (u8 ptr) 10)
  (label loop)
  (set ptr (- ptr 1))
  (set (u8 ptr) (+ (% n 10) 48))
  (set n (/ n 10))
  (if n (goto loop))
  (sys/call 1 1 ptr (- end ptr)))

(fun (boot/fac n)
  (if (< n 2)
      n
      (* n (boot/fac (- n 1)))))

(fun (boot/main)
  (mem ctxt boot/context)
  (mem gfx boot/gfx)
  (set context ctxt)
  (set (boot/ctxt-gfx context) gfx)
  (boot/gfx-init)
  (boot/gfx-rect 0 0 1024 768 (boot/gfx-color 250 250 230))
  (boot/gfx-show)

  (var n 1)
  (while (< n 20)
   (boot/print-int (boot/fac n))
   (set n (+ n 1)))

  (boot/gfx-wait))
