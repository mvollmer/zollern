(struct mem/context
  mem-next
  mem-end)

(defconst mem/page-size (* 16 1024))

(fun (mem/init)
  (var boot-disk (ctxt/disk context))
  (var boot-books (ctxt/books context))
  (var page (sys/page-get))
  (set context page)
  (set (ctxt/disk context) boot-disk)
  (set (ctxt/books context) boot-books)
  (var mem-context (+ page ctxt/contexts))
  (set (mem/mem-next mem-context) (+ mem-context mem/context))
  (set (mem/mem-end mem-context) (+ page mem/page-size))
  (set (ctxt/mem context) mem-context))

(fun (mem/alloc size)
  (var ctxt (ctxt/mem context))
  (var ptr (mem/mem-next ctxt))
  (var end (+ ptr size))
  (if ((> end (mem/mem-end ctxt))
       (set ptr (sys/page-get))
       (set end (+ ptr size))
       (set (mem/mem-end ctxt) (+ ptr mem/page-size))))
  (set (mem/mem-next ctxt) end)
  ptr)

(fun (mem/cpy dst src size)
  (while (> size 0)
   (set (u8 dst) (u8 src))
   (set dst (+ dst 1))
   (set src (+ src 1))
   (set size (- size 1))))
