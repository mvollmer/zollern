(fun (shell/readline buf)
  (con/out "$ ")
  (set (ed/textbuf-len buf) 0)
  (con/in buf)
  (var str (ed/textbuf-maybe-as-string buf))
  (if str
      (con/out str))
  (con/out "\n"))

(fun (shell/parse-args argv max-argc buf)
  (var argc 0)
  (var line (str/skip-whitespace (ed/textbuf-maybe-as-string buf)))
  (while (and (u8 line) (< argc max-argc))
   (set (u64 argv argc) line)
   (set argc (+ argc 1))
   (set line (str/skip-non-whitespace line))
   (if (u8 line)
       (begin
        (set (u8 line) 0)
        (set line (str/skip-whitespace (+ line 1))))))
  argc)

(fun (shell/con-out-with-nl ptr)
  (con/out ptr)
  (con/out "\n"))

(fun (shell/cmd-run argc argv)
  (if (== argc 2)
      (begin
       (if (var book (sys/compile (u64 argv 1) con/out 0))
           (begin
            (if (var main (sys/book-search-fun book "main"))
                (main)
             (con/out "no main function\n"))
            (sys/book-free book))
        (con/out "compilation failed\n")))
   (con/out "usage: run FILE\n")))

(fun (shell/cmd-ed argc argv)
  (if (== argc 2)
      (begin
       (label again)
       (mem edbuf ed/textbuf)
       (mem rbuf fs/rbuf)
       (mem wbuf fs/wbuf)
       (ed/textbuf-init edbuf)
       (if (fs/open rbuf (u64 argv 1))
           (begin
            (ed/textbuf-read-file edbuf rbuf)
            (fs/close rbuf)))
       (var exit-mode (ed/ed edbuf 0 0 0 gfx/screen-width gfx/screen-height))
       (fs/create wbuf)
       (ed/textbuf-write-file edbuf wbuf)
       (fs/commit wbuf (u64 argv 1))
       (ed/textbuf-fini edbuf)
       (if (== exit-mode 2)
           (begin
            (shell/cmd-run argc argv)
            (con/out "RET")
            (mem line ed/textbuf)
            (ed/textbuf-init line)
            (con/in line)
            (con/out "\n")
            (goto again))))
   (con/out "usage: ed FILE\n")))

(fun (shell/cmd-remove argc argv)
  (if (== argc 2)
      (fs/remove (u64 argv 1))
   (con/out "usage: remove FILE\n")))

(fun (shell/main)
  (mem line ed/textbuf)
  (mem file ed/textbuf)
  (mem argv (* 8 16))
  (ed/textbuf-init line)
  (ed/textbuf-init file)
  (while 1
   (shell/readline line)
   (var argc (shell/parse-args argv 16 line))
   (var arg1 (u64 argv))
   (if (str/eq arg1 "quit")
       (sys/call 60 0)
    (if (str/eq arg1 "edit")
        (ed/ed file 0 0 0 gfx/screen-width gfx/screen-height)
     (if (str/eq arg1 "edit-run")
         (begin
          (var text (ed/textbuf-maybe-as-string file))
          (if text
              (if (var book (sys/compile "user" text (+ text (ed/textbuf-len file)) con/out 0))
                  (begin
                   (if (var main (sys/book-search-fun book "main"))
                       (main)
                    (con/out "no user/main function\n"))
                   (sys/book-free book))
               (con/out "compilation failed\n"))))
      (if (str/eq arg1 "list")
          (fs/list shell/con-out-with-nl)
       (if (str/eq arg1 "ed")
           (shell/cmd-ed argc argv)
        (if (str/eq arg1 "run")
            (shell/cmd-run argc argv)
         (if (str/eq arg1 "remove")
             (shell/cmd-remove argc argv)
          (con/out "?\n"))))))))))
