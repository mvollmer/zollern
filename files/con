(struct con/context
  screen-width
  screen-height
  line-height
  cursor-x)

(fun (con/init)
  (var ctxt (mem/alloc con/context))
  (set (ctxt/con context) ctxt)
  (set (con/line-height ctxt) (- (gfx/font-ascent fonts/mono) (gfx/font-descent fonts/mono)))
  (set (con/cursor-x ctxt) 0)
  (set (con/screen-width ctxt) (gfx/width))
  (set (con/screen-height ctxt) (gfx/height))
  (gfx/rect 0 0 (gfx/width) (gfx/height) (gfx/color 255 255 255)))

(fun (con/nl)
  (var ctxt (ctxt/con context))
  (var lh (con/line-height ctxt))
  (gfx/copy-rect-up 0 lh (gfx/width) (- (gfx/height) lh) 0 0)
  (gfx/rect 0 (- (gfx/height) lh) (gfx/width) lh (gfx/color 255 255 255))
  (set (con/cursor-x ctxt) 0)
  (gfx/show))

(fun (con/out str)
  (var ctxt (ctxt/con context))
  (var x (con/cursor-x ctxt))
  (var y (- (gfx/height) (con/line-height ctxt)))
  (while (u8 str)
    (if ((== (u8 str) ch/nl)
         (goto newline)))
    (set x (+ x (gfx/glyph fonts/mono x y (u8 str))))
    (if ((> x (- (gfx/width) 14))
         (label newline)
         (con/nl)
         (set x 0)))
    (set str (+ str 1)))
  (set (con/cursor-x ctxt) x)
  (gfx/show))

(fun (con/out-int n)
  (if ((< n 0)
       (con/out "-")
       (set n (- n))))
  (mem buf 40)
  (var end (+ buf 40))
  (var ptr end)
  (set ptr (- ptr 1))
  (set (u8 ptr) 0)
  (while (begin
           (set ptr (- ptr 1))
           (set (u8 ptr) (+ (% n 10) 48))
           (set n (/ n 10))
           n))
  (con/out ptr))

(fun (con/layout-last-line ed)
  (var ctxt (ctxt/con context))
  (if ((or (!= (con/screen-width ctxt) (gfx/width))
           (!= (con/screen-height ctxt) (gfx/height)))
       (gfx/rect 0 0 (gfx/width) (gfx/height) (gfx/color 255 255 255))
       (set (con/screen-width ctxt) (gfx/width))
       (set (con/screen-height ctxt) (gfx/height))
       (set (con/cursor-x ctxt) 0)))
  (ed/resize ed
             (con/cursor-x ctxt) (- (gfx/height) (con/line-height ctxt))
             (gfx/width) (gfx/height)))

(fun (con/in buf)
  (var ctxt (ctxt/con context))
  (ed/ed 0 buf 1 con/layout-last-line))
