(struct con/context
  line-height
  cursor-x)

(fun (con/init)
  (var ctxt (mem/alloc con/context))
  (set (ctxt/con context) ctxt)
  (set (con/line-height ctxt) (- (gfx/font-ascent sys/mono) (gfx/font-descent sys/mono)))
  (set (con/cursor-x ctxt) 0)
  (gfx/rect 0 0 1024 768 (gfx/color 255 255 255)))

(fun (con/nl)
  (var ctxt (ctxt/con context))
  (var lh (con/line-height ctxt))
  (gfx/copy-rect-up 0 lh 1024 (- 768 lh) 0 0)
  (gfx/rect 0 (- 768 lh) 1024 lh (gfx/color 255 255 255))
  (set (con/cursor-x ctxt) 0)
  (gfx/show))

(fun (con/out str)
  (var ctxt (ctxt/con context))
  (var x (con/cursor-x ctxt))
  (var y (- 768 (con/line-height ctxt)))
  (while (u8 str)
   (if (== (u8 str) 10)
       (goto newline))
   (set x (+ x (gfx/glyph x y (u8 str))))
   (if (> x 1010)
       (begin
        (label newline)
        (con/nl)
        (set x 0)))
   (set str (+ str 1)))
  (set (con/cursor-x ctxt) x)
  (gfx/show))

(fun (con/in buf)
  (var ctxt (ctxt/con context))
  (ed/ed buf 1 (con/cursor-x ctxt) (- 768 (con/line-height ctxt)) 1024 768))
